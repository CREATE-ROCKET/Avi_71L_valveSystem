# C-71L バルブシステム 通信仕様書

# 通信フロー概要

![](figures/serialCom.jpg)

# 通信プロトコルの仕様
| head(1byte) | command(1byte) | length(1byte)    | parameters(nbyte) | parity(1byte) |
|-------------|----------------|------------------|-------------------|---------------|
| `0x71`      |                | n+4              |                   |               |

parityによって通信エラーを検知し，通信エラーの場合そのパケットは破棄するとする．

点火シーケンス前は1Hzのackを流し，点火シーケンス中は100Hzのackを流す

通信エラーの際，マイコン側で充填電磁弁を切断する等のことは，なにもしない．非常時の対処は点火点にてキルスイッチを押すことで行う．

パリティはパラメータの総和を63倍し，256で割った余りである．

## 1. スイッチ状態転送コマンド
| head(1byte) | command(1byte) | length(1byte)    | parameters(1byte) | parity(1byte) |
|-------------|----------------|------------------|-------------------|---------------|
| `0x71`      | `0x21`         | `0x05`           |  `0bEFGH0000`     |               |

`EFGH`...それぞれ外部ダンプ，内部ダンプ，充填，点火スイッチのステータス．`0b1`の場合ONで，`0b0`の場合OFF．

## 2. ロケット基板テレメトリ送信コマンド
| head(1byte) | command(1byte) | length(1byte)    | parameters(6byte) | parity(1byte) |
|-------------|----------------|------------------|-------------------|---------------|
| `0x71`      | `0x61`         | `0d12`           |                   |               |

| param[0]    | param[1-4]  | param[5-6]     | param[7]         |
|-------------|-------------|----------------|------------------|
| swstatus    | time        | pulsecounter   | BRDstatus        |
| same as 1   |             |                | `0bXYZ000RR`     |

`X` ... 基板がアクティブかどうか．アクティブなら`0b1`，light sleep中なら`0b0`．

`YZ` ... 基板の動作モード．

`RR` ... 通信がどこまで到達したかを示す．`00`でロケット基板まで到達，`01`で中継基板まで到達，`10`で中継基板に到達せず．

## 3. 強制遷移コマンド
| head(1byte) | command(1byte) | length(1byte)    | parameters(1byte) | parity(1byte) |
|-------------|----------------|------------------|-------------------|---------------|
| `0x71`      | `0xEE`         | `0x05`           |  `0b0X0YZ0H0`     |               |

`X` ... 基板をアクティブにするかどうか．アクティブにするなら`0b1`，light sleepにするなら`0b0`．

`YZ` ... 動作モードを強制的に指定する．

`H` ... `0b1`の場合バルブの開度を強制的に指定する．開閉のどちらかにするかは`I`を参照

`I` ... バルブについて，`0b1`の場合開き，`0b0`の場合閉める．

応答は1.2.によってわかるため返さないとする．